var H=(c,t,r)=>new Promise((s,a)=>{var b=i=>{try{o(r.next(i))}catch(h){a(h)}},y=i=>{try{o(r.throw(i))}catch(h){a(h)}},o=i=>i.done?s(i.value):Promise.resolve(i.value).then(b,y);o((r=r.apply(c,t)).next())});import{_ as K,aA as Q,aB as j,aC as M,aD as X,aE as Y,r as D,z as P,B as Z,D as C,S as A,n as m,Q as u,G as n,m as S,E as N,H as d,P as I,T as $,K as O,L as ee,N as se,R as z,a7 as te,U as ne}from"./index-pPDUazPi.js";const le={name:"BuildLogViewer",components:{Loading:Y,Document:X,CircleCheck:M,CircleClose:j,DocumentDelete:Q},props:{modelValue:{type:Boolean,default:!1},resourceId:{type:[Number,String],default:null},taskId:{type:String,default:null},title:{type:String,default:"构建日志"},loadingText:{type:String,default:"正在加载日志，请稍候..."},apiPath:{type:String,default:"/api/admin/docker/resource/{id}/logs"}},emits:["update:modelValue","closed"],setup(c,{emit:t}){const r=D(c.modelValue),s=D(!1),a=D([]),b=D(0),y=D(null),o=D(0);let i=null;const h=3e3;P(()=>c.modelValue,e=>{r.value=e,e&&c.resourceId?(V(!0),T()):k()}),P(()=>c.resourceId,e=>{e&&r.value&&(V(!0),T())}),P(r,e=>{t("update:modelValue",e),e||k()});const V=(e=!1)=>H(null,null,function*(){if(c.resourceId){e&&(s.value=!0,o.value=0,a.value=[]);try{let f=c.apiPath.replace("{id}",c.resourceId);const L=new URLSearchParams;o.value>0&&L.append("start",o.value),c.taskId&&L.append("task_id",c.taskId);const F=L.toString();F&&(f+=`?${F}`);const x=yield te.get(f).catch(g=>(console.error("日志API请求失败:",g),g.response&&g.response.status===404?{data:["日志查询接口不存在，请联系管理员添加相应接口"]}:{data:["获取日志失败: "+(g.message||"请求异常")]}));if(x&&x.data){const g=x.data.data||x.data;g.status!==void 0&&(b.value=g.status,(g.status===1||g.status===2)&&k());const p=g.data||g;let w=[];Array.isArray(p)&&p.length>0&&(p[0].stream!==void 0||p[0].error!==void 0||p[0].status!==void 0)?w=p.map(_=>_.error?`错误: ${_.error}`:_.stream?_.stream.trim():_.status?`${_.id?_.id+": ":""}${_.status}`:JSON.stringify(_)).filter(_=>_.trim()!==""):w=Array.isArray(p)?p:p.split(`
`),(w.length!==a.value.length||e)&&(a.value=w,o.value=w.length),(a.value.length===0||a.value.length===1&&a.value[0]==="")&&(a.value=["暂无日志数据，请稍后刷新"]),ne(()=>{y.value&&(y.value.scrollTop=y.value.scrollHeight)})}else e&&(a.value=["暂无日志数据"])}catch(f){console.error("获取日志失败:",f),a.value=["获取日志失败: "+(f.message||"请求异常")]}finally{s.value=!1}}}),T=()=>{k(),i=setInterval(()=>{V(!1)},h)},k=()=>{i&&(clearInterval(i),i=null)},R=()=>{r.value=!1},l=()=>{k(),t("closed")},v=e=>e.includes("SUCCESS")||e.includes("successfully")||e.includes("Successfully")||e.includes("完成")||e.includes("success")||e.includes("done"),B=e=>e.includes("ERROR")||e.includes("FAIL")||e.includes("错误")||e.includes("error")||e.includes("timeout")||e.includes("exceeded")||e.includes("failed")||e.includes("Failed"),E=e=>e.includes("WARNING")||e.includes("WARN")||e.includes("Pulling")||e.includes("警告"),U=e=>e.includes("Step")||e.includes("status")||e.includes("INFO")||e.includes("Building"),W=e=>e.includes(">>>")||e.includes("===")||e.includes("---")||e.includes("###"),G=e=>v(e)?"✓":B(e)?"✗":E(e)?"⚠":U(e)?"ℹ":"",q=(e,f)=>{if(f===0)return!1;if(f%15===0)return!0;if(B(e)||v(e)){const L=a.value[f-1];if(L&&!B(L)&&!v(L))return!0}return!1},J=(e,f)=>B(e)?"错误信息":v(e)?"成功信息":`第 ${f+1} 行`;return Z(()=>{k()}),{dialogVisible:r,loading:s,logs:a,buildStatus:b,logContentRef:y,closeDialog:R,handleDialogClosed:l,isSuccessLog:v,isErrorLog:B,isWarningLog:E,isInfoLog:U,isHighlightLog:W,getLogIcon:G,shouldShowDivider:q,getDividerText:J}}},ae={class:"dialog-header"},oe={class:"header-left"},ie={class:"macos-buttons"},re={class:"header-title"},de={class:"header-right"},ce={class:"log-wrapper"},ue={class:"log-container"},fe={key:0,class:"log-loading"},ge={class:"loading-text"},_e={key:1,class:"log-empty"},me={key:0,class:"log-content",ref:"logContentRef"},ve={key:0,class:"log-divider"},he={class:"divider-text"},pe={class:"line-number"},ye={class:"line-content-wrapper"},ke={key:0,class:"log-icon"},Ce={class:"line-content"};function Le(c,t,r,s,a,b){const y=C("Document"),o=C("el-icon"),i=C("Loading"),h=C("el-tag"),V=C("CircleCheck"),T=C("CircleClose"),k=C("DocumentDelete"),R=C("el-dialog");return m(),A(R,{modelValue:s.dialogVisible,"onUpdate:modelValue":t[1]||(t[1]=l=>s.dialogVisible=l),"close-on-click-modal":!1,onClosed:s.handleDialogClosed,class:"log-dialog","destroy-on-close":"",top:"5vh",width:"70%"},{header:u(()=>[n("div",ae,[n("div",oe,[n("div",ie,[n("span",{class:"macos-btn macos-btn-close",onClick:t[0]||(t[0]=(...l)=>s.closeDialog&&s.closeDialog(...l)),title:"关闭"}),t[2]||(t[2]=n("span",{class:"macos-btn macos-btn-minimize",title:"最小化"},null,-1)),t[3]||(t[3]=n("span",{class:"macos-btn macos-btn-maximize",title:"最大化"},null,-1))]),d(o,{class:"header-icon"},{default:u(()=>[d(y)]),_:1}),n("span",re,I(r.title),1)]),n("div",de,[s.buildStatus===0?(m(),A(h,{key:0,type:"info",size:"small",effect:"dark"},{default:u(()=>[d(o,{class:"is-loading"},{default:u(()=>[d(i)]),_:1}),t[4]||(t[4]=z(" 构建中 ",-1))]),_:1})):s.buildStatus===1?(m(),A(h,{key:1,type:"success",size:"small",effect:"dark"},{default:u(()=>[d(o,null,{default:u(()=>[d(V)]),_:1}),t[5]||(t[5]=z(" 已完成 ",-1))]),_:1})):s.buildStatus===2?(m(),A(h,{key:2,type:"danger",size:"small",effect:"dark"},{default:u(()=>[d(o,null,{default:u(()=>[d(T)]),_:1}),t[6]||(t[6]=z(" 构建失败 ",-1))]),_:1})):N("",!0)])])]),default:u(()=>[n("div",ce,[n("div",ue,[s.loading&&s.logs.length===0?(m(),S("div",fe,[d(o,{class:"is-loading loading-icon"},{default:u(()=>[d(i)]),_:1}),n("span",ge,I(r.loadingText),1)])):s.logs.length===0?(m(),S("div",_e,[d(o,{class:"empty-icon"},{default:u(()=>[d(k)]),_:1}),t[7]||(t[7]=n("span",null,"暂无日志数据",-1))])):N("",!0),d($,{name:"fade",mode:"out-in"},{default:u(()=>[s.logs.length>0?(m(),S("div",me,[(m(!0),S(O,null,ee(s.logs,(l,v)=>(m(),S(O,{key:v},[s.shouldShowDivider(l,v)?(m(),S("div",ve,[t[8]||(t[8]=n("span",{class:"divider-line"},null,-1)),n("span",he,I(s.getDividerText(l,v)),1),t[9]||(t[9]=n("span",{class:"divider-line"},null,-1))])):N("",!0),n("div",{class:se(["log-line",{"log-success":s.isSuccessLog(l),"log-error":s.isErrorLog(l),"log-warning":s.isWarningLog(l),"log-info":s.isInfoLog(l),"log-highlight":s.isHighlightLog(l)}])},[n("span",pe,I(v+1),1),n("div",ye,[s.getLogIcon(l)?(m(),S("span",ke,I(s.getLogIcon(l)),1)):N("",!0),n("pre",Ce,I(l),1)])],2)],64))),128))],512)):N("",!0)]),_:1})])])]),_:1},8,["modelValue","onClosed"])}const Ie=K(le,[["render",Le],["__scopeId","data-v-2864db42"]]);export{Ie as B};
