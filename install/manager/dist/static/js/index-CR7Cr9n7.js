var I=(r,c,t)=>new Promise((a,l)=>{var u=n=>{try{f(t.next(n))}catch(e){l(e)}},d=n=>{try{f(t.throw(n))}catch(e){l(e)}},f=n=>n.done?a(n.value):Promise.resolve(n.value).then(u,d);f((t=t.apply(r,c)).next())});import{_ as P,aA as w,r as y,z as V,B as D,D as S,S as R,n as v,Q as B,G as L,m as h,E as k,H as C,P as A,T,K as b,L as E,N as U,a7 as O}from"./index-BYxaA_Lm.js";const z={name:"BuildLogViewer",components:{Loading:w},props:{modelValue:{type:Boolean,default:!1},resourceId:{type:[Number,String],default:null},title:{type:String,default:"构建日志"},loadingText:{type:String,default:"正在加载日志，请稍候..."},apiPath:{type:String,default:"/api/admin/docker/resource/{id}/logs"}},emits:["update:modelValue","closed"],setup(r,{emit:c}){const t=y(r.modelValue),a=y(!1),l=y([]),u=y(0);let d=null;const f=3e3;V(()=>r.modelValue,o=>{t.value=o,o&&r.resourceId?(n(!0),e()):g()}),V(()=>r.resourceId,o=>{o&&t.value&&(n(!0),e())}),V(t,o=>{c("update:modelValue",o),o||g()});const n=(o=!1)=>I(null,null,function*(){if(r.resourceId){o&&(a.value=!0,u.value=0,l.value=[]);try{let _=r.apiPath.replace("{id}",r.resourceId);u.value>0&&(_+=`?start=${u.value}`);const p=yield O.get(_).catch(s=>(console.error("日志API请求失败:",s),s.response&&s.response.status===404?{data:["日志查询接口不存在，请联系管理员添加相应接口"]}:{data:["获取日志失败: "+(s.message||"请求异常")]}));if(p&&p.data){const s=p.data.data||p.data;let m=[];Array.isArray(s)&&s.length>0&&(s[0].stream!==void 0||s[0].error!==void 0||s[0].status!==void 0)?m=s.map(i=>i.error?`错误: ${i.error}`:i.stream?i.stream.trim():i.status?`${i.id?i.id+": ":""}${i.status}`:JSON.stringify(i)).filter(i=>i.trim()!==""):m=Array.isArray(s)?s:s.split(`
`),u.value+=m.length,o?l.value=m:m.length>0&&(l.value=[...l.value,...m]),(l.value.length===0||l.value.length===1&&l.value[0]==="")&&(l.value=["暂无日志数据，请稍后刷新"])}else o&&(l.value=["暂无日志数据"])}catch(_){console.error("获取日志失败:",_),l.value=["获取日志失败: "+(_.message||"请求异常")]}finally{a.value=!1}}}),e=()=>{g(),d=setInterval(()=>{n(!1)},f)},g=()=>{d&&(clearInterval(d),d=null)},N=()=>{t.value=!1},x=()=>{g(),c("closed")};return D(()=>{g()}),{dialogVisible:t,loading:a,logs:l,closeDialog:N,handleDialogClosed:x}}},F={class:"log-container"},G={key:0,class:"log-loading"},W={key:1,class:"log-empty"},H={key:0,class:"log-content"};function J(r,c,t,a,l,u){const d=S("Loading"),f=S("el-icon"),n=S("el-dialog");return v(),R(n,{modelValue:a.dialogVisible,"onUpdate:modelValue":c[0]||(c[0]=e=>a.dialogVisible=e),title:t.title,width:"50%","close-on-click-modal":!1,onClosed:a.handleDialogClosed,class:"log-dialog","destroy-on-close":"",top:"5vh"},{default:B(()=>[L("div",F,[a.loading&&a.logs.length===0?(v(),h("div",G,[C(f,{class:"is-loading"},{default:B(()=>[C(d)]),_:1}),L("span",null,A(t.loadingText),1)])):a.logs.length===0?(v(),h("div",W," 暂无日志 ")):k("",!0),C(T,{name:"fade",mode:"out-in"},{default:B(()=>[a.logs.length>0?(v(),h("div",H,[(v(!0),h(b,null,E(a.logs,(e,g)=>(v(),h("pre",{key:g,class:U({"log-success":e.includes("SUCCESS")||e.includes("successfully"),"log-error":e.includes("ERROR")||e.includes("FAIL")||e.includes("错误")||e.includes("error")||e.includes("timeout")||e.includes("exceeded"),"log-warning":e.includes("WARNING")||e.includes("WARN")||e.includes("Pulling"),"log-info":e.includes("Step")||e.includes("status")})},A(e),3))),128))])):k("",!0)]),_:1})])]),_:1},8,["modelValue","title","onClosed"])}const j=P(z,[["render",J],["__scopeId","data-v-c9ef65f6"]]);export{j as B};
